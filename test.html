<!DOCTYPE html>
<html>
<meta charset="utf-8">
<head>
    <title>Plateforme d'achat en ligne</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f2f2f2;
        }

        h1 {
            font-size: 32px;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
            text-shadow: 2px 2px #ccc;
        }

        label {
            display: block;
            margin-bottom: 10px;
            color: #666;
        }

        input {
            padding: 10px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 20px;
            background-color: #f9f9f9;
            color: #333;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease-in-out;
            box-shadow: 2px 2px 5px #888;
        }

        button:hover {
            background-color: #3e8e41;
        }

        #max {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
            text-shadow: 2px 2px #ccc;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
            box-shadow: 2px 2px 5px #888;
            height: 30px;
        }

        .highestPrice {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
            padding: 10px;
        }
    </style>
</head>
<body>
<div style="margin: 5% 20%;">
    <h1>Plateforme d'achat en ligne</h1>
    <form>
        <p>
            host : <input id="host" type="text" size="10" value="localhost">
            port : <input id="port" type="text" maxlength="5" size="5" value="4444">
            <br>
            <button id="connecter">Connecter</button>
            <button id="fermer">Fermer</button>
        </p>
    </form>
    <p>Stock restant actuel:</p>
    <div id="max" class="highestPrice">100</div>
    <label for="count">Combien voulez-vous en acheter:</label>
    <input type="number" id="count" min="1">
    <button id="submit" style="margin: 0 auto; display: block;">Submit</button>
    <button id="snapshot" style="margin: 10px auto; display: block;">Snapshot</button>
    <div style="margin-bottom: 40px"></div>
    <hr>
    <b> Logs </b>
    <div id="logs" style="max-height: 40vh;overflow-y: scroll;"></div>
</div>

<script>
    function addToLog(message) {
        var logs = document.getElementById("logs");
        var d = document.createElement("div");
        d.textContent = message;
        logs.appendChild(d);
        logs.scroll(0, logs.scrollHeight);
    }

    var ws;

    document.getElementById("connecter").onclick = function (evt) {
        if (ws) {
            return false;
        }

        var host = document.getElementById("host").value;
        var port = document.getElementById("port").value;

        addToLog("Tentative de connexion");
        addToLog("host = " + host + ", port = " + port);

        ws = new WebSocket("ws://" + host + ":" + port + "/ws");

        ws.onopen = function (evt) {
            addToLog("Websocket ouverte");
        }

        ws.onclose = function (evt) {
            addToLog("Websocket fermée");
            ws = null;
        }

        ws.onmessage = function (evt) {
            const data = JSON.parse(evt.data);
            const maxElement = document.getElementById('max');
            const input = document.getElementById('count');
            console.log(data.number)
            if (data.number != null) {
                maxElement.textContent = data.number;
            }
            if ( data.mylock === 'locked') {
                input.disabled = true;
            } else if (data.mylock === 'unlocked') {
                input.disabled = false;
            }

            addToLog("Réception: " + evt.data);
        }

        ws.onerror = function (evt) {
            addToLog("Erreur: " + evt.data);
        }

        document.getElementById('submit').onclick = function (evt) {
            const input = document.getElementById('count');
            const price = input.value;
            //获取够买数量并重置input
            addToLog("success achat");
            input.value = '';
            const data = {number: price};
            addToLog("Pret: " + data.number);
            const jsonData = JSON.stringify(data);

            // 直接发送数据
            ws.send(jsonData);
            addToLog("Emission: " + data.number);
            return false;
        }

        document.getElementById('fermer').onclick = function (evt) {
            ws.close();
            return false;
        }

        return false;
    }

    document.getElementById('snapshot').onclick = function (evt) {
        const data = {text:"demand snapshot"};
        const jsonData = JSON.stringify(data);

        // 发送快照请求
        ws.send(jsonData);
        addToLog("Emission: " + data.text);
        return false;
    }



    // 前端调用后端API获取当前最高价格
    function getMaxPrice() {
        // 替换为实际的后端API URL
        fetch("http://localhost:8080")
            .then(response => response.json())
            .then(data => log.alert(data));
    }

    // 前端调用后端API发起拍卖请求
    function putMyPrice(price) {
        // 替换为实际的后端API URL
        fetch("http://localhost/put_my_price", {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({price: price})
        })
            .then(response => {
                if (response.ok) {
                    // 提交成功，重新获取最高价格并更新显示
                    getMaxPrice();
                    alert("出价成功！");
                } else {
                    // 提交失败，显示错误信息
                    alert("出价失败：" + response.statusText);
                }
            })
            .catch(error => console.error(error));
    }

    // 提交出价按钮的点击事件处理程序
    function submitBid() {
        // 获取输入的出价
        let bidInput = document.getElementById("bidInput");
        let bidAmount = parseFloat(bidInput.value);
        if (isNaN(bidAmount)) {
            alert("请输入有效的数字！");
            return;
        }
        // 获取当前最高价格
        let highestBid = parseFloat(document.getElementById("highestBidDisplay").innerHTML.substr(1));
        // 判断出价是否高于当前最高价格
        if (bidAmount > highestBid) {
            // 发起拍卖请求
            putMyPrice(bidAmount);
        } else {
            alert("您的出价必须高于当前最高价格！");
        }
        // 清空输入框
        bidInput.value = "";
    }

    // 页面加载时获取最高价格并显示
    getMaxPrice();
</script>
</body>
</html>
