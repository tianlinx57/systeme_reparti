<!DOCTYPE html>
<html>
<meta charset="utf-8">
<head>
	<title>网络拍卖会</title>
	<style>
		body {
			font-family: Arial, sans-serif;
			background-color: #f2f2f2;
		}
		h1 {
			font-size: 32px;
			margin-bottom: 20px;
			color: #333;
			text-align: center;
			text-shadow: 2px 2px #ccc;
		}
		label {
			display: block;
			margin-bottom: 10px;
			color: #666;
		}
		input {
			padding: 10px;
			border: none;
			border-radius: 4px;
			font-size: 16px;
			width: 100%;
			box-sizing: border-box;
			margin-bottom: 20px;
			background-color: #f9f9f9;
			color: #333;
		}
		button {
			background-color: #4CAF50;
			color: white;
			padding: 10px 20px;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-size: 16px;
			transition: background-color 0.3s ease-in-out;
			box-shadow: 2px 2px 5px #888;
		}
		button:hover {
			background-color: #3e8e41;
		}
		#highestBidDisplay {
			font-size: 24px;
			font-weight: bold;
			margin-bottom: 20px;
			color: #333;
			text-shadow: 2px 2px #ccc;
			padding: 10px;
			background-color: #f9f9f9;
			border-radius: 4px;
			box-shadow: 2px 2px 5px #888;
		}
        .highestPrice {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
            padding: 10px;
        }
	</style>
</head>
<body>
	<div style="margin: 20%;">
        <h1>网络拍卖会</h1>
        <form>
            <p>
                host : <input id="host" type="text" size="10" value="localhost">
                port : <input id="port" type="text" maxlength="5" size="5" value="4444">
                <br>
                <button id="connecter">Connecter</button>
                <button id="fermer">Fermer</button>
            </p>
        </form>
        <p>当前最高价格:</p>
        <p id="max" class="highestPrice"></p>
        <div id="highestBidDisplay">$0</div>
        <label for="bidInput">输入你想出价的价格:</label>
        <input type="number" id="bidInput">
		<button id="putPrice" style="margin: 0 auto; display: block;">提交出价</button>
        <hr>
        <b> Logs </b>
        <div id="logs" style="max-height: 40vh;overflow-y: scroll;"></div>
    </div>

	<script>
        function addToLog(message) {
            var logs = document.getElementById("logs");
            var d = document.createElement("div");
            d.textContent = message;
            logs.appendChild(d);
            logs.scroll(0, logs.scrollHeight);
        }
        //创建从服务器接收json的websocket
        var ws1
        document.getElementById("connecter").onclick = function(evt) {
            if (ws1) {
                return false;
            }

            var host = document.getElementById("host").value;
            var port = document.getElementById("port").value;

            addToLog("Tentative de connexion")
            addToLog("host = " + host + ", port = " + port)

            ws1 = new WebSocket("ws://"+host+":"+port+"/ws1");

            ws1.onopen = function(evt) {
                addToLog("Websocket ouverte");
            }

            ws1.onclose = function(evt) {
                addToLog("Websocket fermée");
                ws = null;
            }

            ws1.onmessage = function(evt) {
                const data = JSON.parse(evt.data);
                const maxElement = document.getElementById('max');
                maxElement.textContent = data.number
                addToLog("Réception: " + evt.data);
            }

            ws1.onerror = function(evt) {
                addToLog("Erreur: " + evt.data);
            }
            return false;
        }
        ////创建向服务器发送json的websocket
        var ws2
        document.getElementById('putPrice').onclick = function(evt) {
            const input = document.getElementById('bidInput')
            const price = input.value
            //获取出价并重置input
            addToLog("提交成功")
            input.value = ''
            const data = { number: price };
            addToLog("Pret: " + data.number);
            const jsonData = JSON.stringify(data);

            if (ws2==null) {
                var host = document.getElementById("host").value;
                var port = document.getElementById("port").value;
                ws2 = new WebSocket("ws://" + host + ":" + port + "/ws2");
                addToLog("新建");
                //监听socket开启就发送数据
                ws2.addEventListener('open', function(evt) {
                    ws2.send(jsonData);
                    addToLog("Emission: " + data.number);
                });
            }
            //直接发送数据
            ws2.send(jsonData);
            addToLog("Emission: " + data.number);

            ws2.onopen = function(evt) {
                addToLog("Websocket ouverte");
            }

            ws2.onclose = function(evt) {
                addToLog("Websocket fermée");
                ws = null;
            }

            ws2.onmessage = function(evt) {
                addToLog("Réception: " + evt.data);
            }

            ws2.onerror = function(evt) {
                addToLog("Erreur: " + evt.data);
            }
            return false;
        }


        // 前端调用后端API获取当前最高价格
		function getMaxPrice() {
			// 替换为实际的后端API URL
			fetch("http://localhost:8080")
			    .then(response => response.json())
                .then(data => log.alert(data));
		}

		// 前端调用后端API发起拍卖请求
		function putMyPrice(price) {
			// 替换为实际的后端API URL
			fetch("http://localhost/put_my_price", {
				method: 'PUT',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({ price: price })
			})
			.then(response => {
                if (response.ok) {
				// 提交成功，重新获取最高价格并更新显示
				getMaxPrice();
				alert("出价成功！");
			} else {
				// 提交失败，显示错误信息
				alert("出价失败：" + response.statusText);
			}
		})
		.catch(error => console.error(error));
	}

	// 提交出价按钮的点击事件处理程序
	function submitBid() {
		// 获取输入的出价
		let bidInput = document.getElementById("bidInput");
		let bidAmount = parseFloat(bidInput.value);
		if (isNaN(bidAmount)) {
			alert("请输入有效的数字！");
			return;
		}
		// 获取当前最高价格
		let highestBid = parseFloat(document.getElementById("highestBidDisplay").innerHTML.substr(1));
		// 判断出价是否高于当前最高价格
		if (bidAmount > highestBid) {
			// 发起拍卖请求
			putMyPrice(bidAmount);
		} else {
			alert("您的出价必须高于当前最高价格！");
		}
		// 清空输入框
		bidInput.value = "";
	}

	// 页面加载时获取最高价格并显示
	getMaxPrice();
</script>
</body>
</html>
